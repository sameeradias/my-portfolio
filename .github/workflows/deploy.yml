name: Build, Dockerize and Deploy

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: portfolio
  CONTAINER_NAME: portfolio-app

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE_NAME }}:latest \
                       -t ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} .

      - name: Stop and remove existing container
        run: |
          docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true

      - name: Run new container
        run: |
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --restart unless-stopped \
            -p ${{ secrets.APP_PORT || 3000 }}:3000 \
            ${{ env.DOCKER_IMAGE_NAME }}:latest

      - name: Clean up old images
        run: |
          docker image prune -f

      - name: Verify deployment
        run: |
          sleep 5
          if docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
            echo "✅ Deployment successful! Container is running."
            docker logs --tail 20 ${{ env.CONTAINER_NAME }}
          else
            echo "❌ Deployment failed! Container is not running."
            docker logs --tail 50 ${{ env.CONTAINER_NAME }}
            exit 1
          fi
